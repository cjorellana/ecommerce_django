{% load static %}
<div class="row prod-items prod-items-2">
    {% for producto in productos %}
    <article class="cf-sm-6 cf-md-6 cf-lg-6 col-xs-6 col-sm-6 col-md-6 col-lg-6 sectgl-item">
        <div class="sectgl prod-i">
            <div class="prod-i-top">
                <a class="prod-i-img" href="{% url 'web:producto' producto.id %}">
                    {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}" alt="">
                    {% else %}
                        <img src="{% static 'img/250x250.svg' %}" alt="Producto sin imagen">
                    {% endif %}
                </a>
                <div class="prod-i-actions">
                    <div class="prod-i-actions-in">                        
                        <p class="prod-i-cart">
                            <a href="#" class="hover-label prod-addbtn" onclick="agregarAlCarrito(event, '{{ producto.id }}', '{{ producto.nombre }}')"><i class="icon ion-android-cart"></i><span>Añadir al carrito</span></a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="prod-i-bot">
                <div class="prod-i-info">
                    <p class="prod-i-price">Q {{ producto.precio }}</p>
                    <p class="prod-i-categ"><a href="#">{{ producto.Categoria }}</a></p>
                </div>
                <h3 class="prod-i-ttl"><a href="{% url 'web:producto' producto.id %}">{{ producto.nombre }}</a></h3>
            </div>
        </div>
    </article>
    {% endfor %}
</div>

<!-- Form para el envío de productos al carrito -->
<form id="add-to-cart-form" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="cantidad" value="1">
</form>

<script>
function agregarAlCarrito(event, productoId, nombreProducto) {
    event.preventDefault();
    
    // Mostrar confirmación con SweetAlert2
    Swal.fire({
        title: 'Añadir al carrito',
        text: `¿Quieres añadir "${nombreProducto}" a tu carrito?`,
        icon: 'question',        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: '✅ Sí, añadir',
        cancelButtonText: '❌ Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Obtener el formulario y configurar la URL
            const form = document.getElementById('add-to-cart-form');
            form.action = '{% url "web:add_cart" 0 %}'.replace('0', productoId);
            
            // Enviar el formulario sin redireccionar
            const formData = new FormData(form);
              fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {                if (data.success) {
                    // Actualizar contador del carrito si existe
                    if (data.cart_count !== undefined) {
                        // Actualizar el contador del carrito en el ícono
                        const cartCountElement = document.querySelector('.h-cart-icon span');
                        if (cartCountElement) {
                            cartCountElement.textContent = data.cart_count;
                        }
                        
                        // Actualizar el mini-carrito sin recargar la página
                        actualizarMiniCarrito();
                    }
                      // Mostrar mensaje de éxito
                    Swal.fire({
                        title: '¡Añadido!',
                        text: data.message || `"${nombreProducto}" ha sido añadido a tu carrito.`,
                        icon: 'success',
                        showCancelButton: true,                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: '🛒 Ir al carrito',
                        cancelButtonText: '🏠 Seguir comprando'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Redirigir al carrito si el usuario lo desea
                            window.location.href = '{% url "web:carrito" %}';
                        }
                    });
                } else {
                    // Mostrar mensaje de error si el servidor indica un problema
                    Swal.fire(
                        'Error',
                        data.message || 'No se pudo añadir el producto al carrito.',
                        'error'
                    );
                }
            })            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Ha ocurrido un problema al añadir el producto al carrito. Por favor, inténtalo de nuevo.',
                    icon: 'error',
                    confirmButtonColor: '#3085d6'
                });            });
        }
    });
}

// Función para actualizar el contenido del mini-carrito
function actualizarMiniCarrito() {
    // Hacer una petición para obtener los datos actualizados del carrito
    fetch('{% url "web:carrito" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Extraer solo la parte del mini-carrito del HTML completo
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Actualizar el contador en el icono del carrito
        const cartCount = doc.querySelector('.h-cart-icon span').textContent.trim();
        document.querySelector('.h-cart-icon span').textContent = cartCount;
        
        // Actualizar el subtotal en el icono del carrito
        const cartTotal = doc.querySelector('.h-cart-total').textContent.trim();
        document.querySelector('.h-cart-total').textContent = cartTotal;
        
        // Buscar el contenido del carrito en el HTML
        const cartList = doc.querySelector('.cart_list');
        if (cartList) {
            document.querySelector('.cart_list').innerHTML = cartList.innerHTML;
        }
        
        // Actualizar el subtotal en el dropdown del carrito
        const totalElement = doc.querySelector('.widget_shopping_cart_content .total');
        if (totalElement) {
            document.querySelector('.widget_shopping_cart_content .total').innerHTML = totalElement.innerHTML;
        }
    })
    .catch(error => {
        console.error('Error al actualizar el mini-carrito:', error);
    });
}
</script>
