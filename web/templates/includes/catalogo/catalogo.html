{% load static %}
<div class="row prod-items prod-items-2">
    {% for producto in productos %}
    <article class="cf-sm-6 cf-md-6 cf-lg-6 col-xs-6 col-sm-6 col-md-6 col-lg-6 sectgl-item">
        <div class="sectgl prod-i">
            <div class="prod-i-top">
                <a class="prod-i-img" href="{% url 'web:producto' producto.id %}">
                    {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}" alt="">
                    {% else %}
                        <img src="{% static 'img/250x250.svg' %}" alt="Producto sin imagen">
                    {% endif %}
                </a>
                <div class="prod-i-actions">
                    <div class="prod-i-actions-in">                        
                        <p class="prod-i-cart">
                            <a href="#" class="hover-label prod-addbtn" onclick="agregarAlCarrito(event, '{{ producto.id }}', '{{ producto.nombre }}')"><i class="icon ion-android-cart"></i><span>A√±adir al carrito</span></a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="prod-i-bot">
                <div class="prod-i-info">
                    <p class="prod-i-price">Q {{ producto.precio }}</p>
                    <p class="prod-i-categ"><a href="#">{{ producto.Categoria }}</a></p>
                </div>
                <h3 class="prod-i-ttl"><a href="{% url 'web:producto' producto.id %}">{{ producto.nombre }}</a></h3>
            </div>
        </div>
    </article>
    {% endfor %}
</div>

<!-- Form para el env√≠o de productos al carrito -->
<form id="add-to-cart-form" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="cantidad" value="1">
</form>

<script>
function agregarAlCarrito(event, productoId, nombreProducto) {
    event.preventDefault();
    
    // Mostrar confirmaci√≥n con SweetAlert2
    Swal.fire({
        title: 'A√±adir al carrito',
        text: `¬øQuieres a√±adir "${nombreProducto}" a tu carrito?`,
        icon: 'question',        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: '‚úÖ S√≠, a√±adir',
        cancelButtonText: '‚ùå Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Obtener el formulario y configurar la URL
            const form = document.getElementById('add-to-cart-form');
            form.action = '{% url "web:add_cart" 0 %}'.replace('0', productoId);
            
            // Enviar el formulario sin redireccionar
            const formData = new FormData(form);
              fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Actualizar contador del carrito si existe
                    if (data.cart_count !== undefined) {
                        const cartCountElement = document.querySelector('.header-cart-count');
                        if (cartCountElement) {
                            cartCountElement.textContent = data.cart_count;
                        }
                    }
                      // Mostrar mensaje de √©xito
                    Swal.fire({
                        title: '¬°A√±adido!',
                        text: data.message || `"${nombreProducto}" ha sido a√±adido a tu carrito.`,
                        icon: 'success',
                        showCancelButton: true,                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'üõí Ir al carrito',
                        cancelButtonText: 'üè† Seguir comprando'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Redirigir al carrito si el usuario lo desea
                            window.location.href = '{% url "web:carrito" %}';
                        }
                    });
                } else {
                    // Mostrar mensaje de error si el servidor indica un problema
                    Swal.fire(
                        'Error',
                        data.message || 'No se pudo a√±adir el producto al carrito.',
                        'error'
                    );
                }
            })            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Ha ocurrido un problema al a√±adir el producto al carrito. Por favor, int√©ntalo de nuevo.',
                    icon: 'error',
                    confirmButtonColor: '#3085d6'
                });
            });
        }
    });
}
</script>
